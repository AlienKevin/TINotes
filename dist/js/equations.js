const newEquationBtn=document.getElementById("newEquationBtn"),eqLength=20;let guppyInput,warningTimerId;function displayEquation(e,t,n){console.log("displaying equation...");const o=document.getElementById("editField");if(o){o.remove(),o.getAttribute("data-item")!==t&&displayEquation(e,t,n)}else openEquationEditField(t,n,e)}function storeEquation(e,t){document.getElementById("eqInput");t.equation=getEquation(!1),t.varEquations=getVarEquations(),t.varDescriptions=getVarDescriptions(),setItemInStorage(e,t)}function getVarDescriptions(){const e={};return Array.from(document.getElementsByClassName("descriptionInput")).forEach(t=>{const n=t.getAttribute("data-var");n&&(e[n]=t.value)}),e}function getVarEquations(){const e={};return Array.from(document.getElementsByClassName("eqInput")).forEach(t=>{const n=t.getAttribute("data-var");n&&(e[n]=t.value)}),e}guppyOSK=new GuppyOSK,Guppy.use_osk(new GuppyOSK({goto_tab:"arithmetic",attach:"focus"})),newEquationBtn.addEventListener("click",()=>{createMenuItem("equation")}),Mousetrap.bind("shift+e",e=>(newEquationBtn.click(),!1));const equationTextToSymbol={"absolutevalue(":"abs(","squareroot(":"sqrt("};function convertTextToSymbol(e){return Object.entries(equationTextToSymbol).forEach(([t,n])=>{e=e.replace(new RegExp(RegExp.escape(t),"g"),n)}),e}function convertSymbolToText(e){return Object.entries(equationTextToSymbol).forEach(([t,n])=>{e=e.replace(new RegExp(RegExp.escape(n),"g"),t)}),e}function getEquation(e){try{let t=convertTextToSymbol(guppyInput.engine.get_content("text"));return t=handleSubscripts(t,e),console.log("TCL: getEquation -> equation",t),detachWarning(eqInput),t}catch(e){warningTimerId=setTimeout(()=>{AttachWarning(eqInput)},500)}return new Error("error loading equation")}function handleVarNameSubscripts(e){return e.indexOf("_")>=0?handleSubscripts(`(${e})`,!0):e}function handleSubscripts(e,t=!0){if(e.indexOf("_")>=0){let n=0,o=e.indexOf("_",n);for(;o>=0;){const r=e.lastIndexOf("(",o);let a,i,s=findClosingBracketMatchIndex(e,r);t?(o+1<e.length&&"("!==e.charAt(o+1)&&(e=insertSubstring(e,o+1,"("),e=insertSubstring(e,s+1,")"),s+=2),a=o+2,i=s-1):(o+1<e.length&&"("===e.charAt(o+1)&&(e=deleteSubstring(e,o+1,1),e=deleteSubstring(e,s-1,1),s-=2),a=o+1,i=s+1);let u="";for(let n=a;n<i;n++){const o=e.substring(n,n+1);"("!==o&&")"!==o&&"*"!=o&&" "!=o&&(u+=o,t&&n<i-1&&(u+="*"))}e=insertSubstring(e,a,u,i-o-2),n=o+1,o=e.indexOf("_",n)}return e}return e}function AttachWarning(e){e.parentNode.querySelector(".warning")||e.insertAdjacentHTML("afterend",'<i class="fa fa-exclamation-triangle warning" aria-hidden="true"></i>')}function detachWarning(e){const t=e.parentNode.querySelector(".warning");t?t.remove():clearTimeout(warningTimerId)}function setEquation(e){e&&(console.log("TCL: setEquation -> convertSymbolToText(equation)",convertSymbolToText(e)),guppyInput.import_text(handleSubscripts(convertSymbolToText(e)),!0),guppyInput.engine.end(),guppyInput.activate(),guppyInput.render(!0))}function createEquationEditor(){const e=document.createElement("div");return e.id="editField",e.classList.add("editor"),e.setAttribute("data-type","equation"),e.insertAdjacentHTML("afterbegin",`<div>\n    <label for="eqInput">Equation: </label>\n    <div id="eqInput" type="text" size="${eqLength}" spellcheck="false"></div>\n    </div>\n    `),e}function removeExtraGuppyOSKTabs(){document.querySelector("#guppy_osk_tab_calculus").remove(),document.querySelector("#guppy_osk_tab_array").remove(),document.querySelector("#guppy_osk_tab_editor").remove(),document.querySelector("#guppy_osk_tab_emoji").remove(),document.querySelector("#guppy_osk_tab_operations").remove(),document.querySelector("body > div.guppy_osk > div.tabbar > div.scroller-left").remove(),document.querySelector("body > div.guppy_osk > div.tabbar > div.scroller-right").remove(),setTimeout(function(){document.querySelector("#functions > span:nth-child(1)").remove(),document.querySelector("#functions > span:nth-child(2)").remove(),document.querySelector("#functions > span:nth-child(4)").remove();for(let e=0;e<4;e++)document.querySelector("#functions > span:nth-child(8)").remove();console.log("removing extra greek letters..."),document.querySelectorAll("#greek span > span.katex-mathml > math > semantics > mrow > mi").forEach(e=>{const t=e.innerHTML;Object.values(conversionTable).indexOf(t)<0&&e.closest("span.guppy_osk_key").remove()}),document.querySelectorAll("#trigonometry span > span > span.katex-mathml > math > semantics > mrow > mi").forEach(e=>{const t=e.innerHTML;["cos","sin","tan","arccos","arcsin","arctan","log","ln"].indexOf(t)<0&&e.closest("span.guppy_osk_key").remove()})},100)}function openEquationEditField(e,t,n){const o=createEquationEditor();o.setAttribute("data-item",e),void 0===n?system.appendChild(o):insertAfter(n,o);const r=document.getElementById("eqInput");function a(e){let t=[];try{t=nerdamer(handleSubscripts(e.replace(/\=/g," "),!1)).variables(),console.log("TCL: getEquationVars -> variables",t),console.log("Handling subscripts in equation vars..."),deleteStrInArray("ln",t)}catch(e){}return t}function i(e){console.log("TCL: createVarTable -> varInfo",e);const t=getEquation();detachWarning(r);const n=a(t);let i=document.getElementById("varTable");if(n.length>0){let t="\n            <thead>\n            <tr>\n                <th>Vars</th>\n                <th>Equations</th>\n                <th>Description</th>\n            </tr>\n            </thead>";if(n.forEach(e=>{t+=createNewRowHTML(e)}),i||((i=document.createElement("table")).id="varTable"),i.innerHTML=t,o.appendChild(i),void 0!==e){const t=e.varEquations;console.log("TCL: createVarTable -> varEquations",t);const n=e.varDescriptions;console.log("TCL: createVarTable -> varDescriptions",n),t&&(loadVarEquations(t),renderEquationVars()),n&&loadVarDescriptions(n)}}}r.classList.add("eqInput"),(guppyInput=new Guppy("eqInput")).configure("blacklist",["norm","utf8","eval","integral","defintegral","derivative","summation","product","root","vector","point","matrix","infinity","banana","pineapple","kiwi","mango","sinh","cosh","tanh","zeta","eta","iota","kappa","nu","xi","upsilon","chi","psi","omega","Theta","Lambda","Xi","Pi","Psi"]),guppyInput.configure("cliptype","text"),guppyInput.configure("button",["osk","settings","symbols","controls"]),guppyInput.event("change",function(){const e=getEquation();console.log("TCL: updateVarTable -> eq",e);const t=a(e);console.log("TCL: updateVarTable -> vars",t);let n=document.getElementById("varTable");if(n){const o=n.querySelectorAll("tbody tr"),r=[];o.forEach(e=>{r.push(e.getAttribute("data-var"))}),t.forEach(t=>{const o=n.getElementsByTagName("tbody")[0];if(r.indexOf(t)<0){const e=createNewRowHTML(t);o.insertAdjacentHTML("beforeend",e)}const a=o.querySelector(`.eqInput[data-var=${t}]`);console.log("Solving var equations..."),a.value=solveEquation(e,t)}),t.length>0&&o.forEach(e=>{const n=e.getAttribute("data-var");t.indexOf(n)<0&&e.remove()}),!e instanceof Error&&""===e&&n&&n.remove()}else i();renderEquationVars()}),guppyInput.event("focus",e=>{e.focused&&(removeExtraGuppyOSKTabs(),o.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}))}),o.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),void 0!==t&&(t.equation&&setEquation(t.equation),console.log("Creating Var Table ..."),i(t))}function solveEquation(e,t){console.log("TCL: solveEquation -> equation",handleSubscripts(e,!1));const n=nerdamer.solve(handleSubscripts(e,!1),t);let o="";return n.symbol&&n.symbol.elements&&n.symbol.elements.some(e=>(console.log("TCL: solveEquation -> element",e.text()),!(e.symbol&&!1!==e.symbol.isImaginary()||("#"===e.value?!e.gte(0):!1!==nerdamer(e.text()).evaluate().text().startsWith("-")))&&(console.log("Result is greater than 0!"),o=e.text(),!0))),o}function renderEquationVars(){console.log("TCL: renderEquationVars -> renderEquationVars");const e=Guppy.Doc.render_all("text","$$");console.log("TCL: renderEquationVars -> result",e);const t=document.getElementById("varTable");t&&t.querySelectorAll("tbody tr").forEach(e=>{console.log("TCL: renderEquationVars -> row",e);const t=e.querySelector(".guppy-render");t&&"ERROR: undefined"===t.innerHTML&&(e.querySelector("th").innerHTML=`$$${e.getAttribute("data-var")}$$`)})}function createNewRowHTML(e){let t=`<tr data-var="${e}"><th>$$${handleVarNameSubscripts(e)}$$</th><td>`;t+=`<input type="text" size="${eqLength}" class="eqInput" data-var="${e}" spellcheck="false"></td>`;const n=lineLength-e.length-1;return t+=`<td><input type="text" class="descriptionInput" \nsize=${n} maxlength=${n} data-var="${e}" spellcheck="false"`,t+="</tr>"}function loadVarDescriptions(e){Array.from(document.getElementsByClassName("descriptionInput")).forEach(t=>{const n=t.getAttribute("data-var");if(n){const o=e[n];o&&(t.value=o)}})}function loadVarEquations(e){Array.from(document.getElementsByClassName("eqInput")).forEach(t=>{const n=t.getAttribute("data-var");if(n){const o=e[n];o&&(t.value=o)}})}