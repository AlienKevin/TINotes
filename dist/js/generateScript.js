const generateScriptBtn=document.getElementById("generateScriptBtn");generateScriptBtn.addEventListener("click",exportScript);const downloadScriptBtn=document.getElementById("downloadScriptBtn"),copyScriptBtn=document.getElementById("copyScriptBtn"),defaultScriptFormat="sourceCoder";let script,startEquationIndex,equationIndex,itemSize=calculateItemSize();function calculateItemSize(){let e=0;return iterateStorage(function(){e+=1}),++e}function calculateFolderSize(){let e=0;return iterateStorage(function(t,n,r){"folder"===r&&(e+=1)}),e}function calculateEquationVarSize(){let e=0;return iterateStorage(function(t,n,r){"equation"===r&&(e+=Object.keys(t.varEquations).length)}),e}function exportScript(){generateScript(),changeScriptFormat(defaultScriptFormat);const e=document.querySelector("#popup div.modal-body");let t=document.getElementById("viewer");t&&t.remove(),(t=createFileEditor("viewer")).value=script,t.readOnly=!0;const n=document.getElementById("scriptFormatSelector");e.insertBefore(t,n),document.querySelectorAll('input[name="scriptFormat"]').forEach(e=>{e.addEventListener("change",e=>{scriptFormat=e.target.value,changeScriptFormat(scriptFormat)})}),script=script.replace(/\n/g,"\r\n")}function changeScriptFormat(e){const t={"→":"->","⌊":"|L","≠":"!="};switch(e){case"sourceCoder":Object.entries(t).forEach(([e,t])=>{script=script.replace(new RegExp(RegExp.escape(e),"g"),t)}),script=convertSymbolsToWords(script);break;case"TIBasic":Object.entries(t).forEach(([e,t])=>{script=script.replace(new RegExp(RegExp.escape(t),"g"),e)}),script=convertWordsToSymbols(script)}let n=document.getElementById("viewer");n&&(n.value=script)}function selectAllItems(){}function generateScript(){itemSize=calculateItemSize();const e=calculateFolderSize(),t=calculateEquationVarSize();equationIndex=startEquationIndex=itemSize+e+1,script="0->N\n1->W\nLbl S\n",t>0&&(script+=`{0${",0".repeat(t-1)}}->|LV\n`),script+=generateScriptHelper("home",0),script+=`${baseScript}`}function generateScriptHelper(e,t){let n=`If N=${t}\nThen\nN->|LA(W)\n`;n+=`Menu("${getEndOfPosition(e)}"`;let r="";const i=[];return iterateStorage(function(t,o,c,a,l){a===e&&(l++,n+=`,"${getEndOfPosition(o)}",${l}`,r+="file"===c?generateFileScript(l,t.content):"equation"===c?generateEquationScript(l,t):generateScriptHelper(o,l),i.push(l))}),"home"!==e?(n+=`,"Back",${itemSize}`,n+=")\n",n+=`Lbl ${itemSize}\n`,n+="W-1->W\n|LA(W)->N\nGoto S\n",itemSize++):n+=")\n",i.forEach((e,t)=>{if(n+=`Lbl ${e}\n`,t>0){n+="If ";for(let e=0;e<t;e++)e>0&&(n+=" and "),n+=`N!=${i[e]}`;n+="\n"}n+=`${e}->N\n`}),script=`${n+="W+1->W\nEnd\n"}\n${r}`}function convertEquationToTIFormat(e){return e=e.replace(/\^\s*([2-3]|-1)($|[^0-9])/g,"^^$1$2").replace(/\_/g,"")}function simplifyEquation(e){let t;return e.indexOf("=")>=0?(eqSegments=e.split("="),t=simplifyEquation(eqSegments[0])+"="+simplifyEquation(eqSegments.slice(1).join(""))):t=math.simplify(e).toString(),t.replace(/ /g,"")}function generateEquationScript(e,t){const n=convertEquationToTIFormat(simplifyEquation(t.equation)),r=t.varEquations;console.log("TCL: generateEquationScript -> vars",r);const i=Object.keys(r),o=t.varDescriptions,c=i.length;console.log("TCL: generateEquationScript -> varLength",c);const a=[],l=equationIndex,s=equationIndex+c;for(let e=l;e<s;e++)l===startEquationIndex?a.push(`LV${e-startEquationIndex+1}`):a.push(`LV${e-startEquationIndex}`);console.log("TCL: generateEquationScript -> varNames",i);let u=`If N=${e}\nThen\n`;u+=`Disp "${n}"\nPause \n${equationIndex-1}->L\nN->|LA(W)\n`;let p='Menu("Solve For"',d="",S="",g="";for(let e=l;e<s;e++){const t=i[e-l],n=o[t];let c;const u=`|LV(${c=l===startEquationIndex?e-startEquationIndex+1:e-startEquationIndex})`,m=r[t],E=substituteVarNames(r[t],i,a);console.log("TCL: generateEquationScript -> varEquation",m),isFinite(nerdamer(m).evaluate().text())?(console.log("TCL: generateEquationScript -> varEquation"+m+" is finite"),S+=`${E}->${u}\n`):(p+=n?`,"${t}-${n}",${e}`:`,"${t}",${e}`,S+=`If (L!=${e})\nThen\nInput "${t}=",T\n`,S+=`T->${u}\nEnd\n`,g+=`If L=${e}\nThen\n"${t}="->Str2\n${E}->V\nEnd\n`),d+=`Lbl ${l-1+s-e}:L+1->L\n`}p+=")\n",g+="{0,.5,1->L1\nVL1->L2\nMed-Med {Y1}\nEqu>String({Y1},Str1\nsub(Str1,1,length(Str1)-3->Str1\n",g+="DelVar L1DelVar L2DelVar {Y1}\n",g+="Disp Str2+Str1\n",g+='Disp "';for(let e=0;e<lineLength;e++)g+="~";return u+=p+d+S+(g+='"\n')+"Repeat K=21\ngetKey->K\nEnd\nW-1->W\n|LA(W)->N\nGoto S\n",equationIndex+=c+1,u+="End\n"}function substituteVarNames(e,t,n){const r={};for(let e=0;e<t.length;e++)r[t[e]]=n[e];let i=handleScientificNotations(nerdamer(e,r).text("decimals"));return i=convertMinusesToNegations(i=i.replace(/LV([0-9]+)/g,"|LV($1)"))}function handleScientificNotations(e){return e.replace(/([+\-]?(?:0|[1-9]\d*)(?:\.\d*)?)(?:e([+\-]?\d+))/g,"$1|E$2")}function convertMinusesToNegations(e){return"-"===e[0]&&(e="~"+e.substring(1)),e=(e=e.replace(/\(\-/g,"(~")).replace(/\|E-/g,"|E~")}function generateFileScript(e,t){return`If N=${e}\n"${t}"->Str1\n`}function download(e,t){var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}downloadScriptBtn.addEventListener("click",()=>{download("TINOTES.txt",script)}),copyScriptBtn.addEventListener("click",()=>{document.getElementById("viewer").select(),document.execCommand("copy"),swal({title:"File Copied!",icon:"success",buttons:!1,timer:800})});