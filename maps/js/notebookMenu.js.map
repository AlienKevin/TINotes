{"version":3,"sources":["notebookMenu.js"],"names":["localforage","setDriver","WEBSQL","INDEXEDDB","metaInfo","createInstance","name","iterate","value","key","console","log","toggleBtn","document","querySelector","sidebar","getElementById","notebookMenu","addNotebookBtn","addEventListener","event","preventDefault","classList","toggle","selectedNotebookName","notebookNameList","defaultNotebookName","storeMetaInfo","clear","then","Promise","all","setMetaInfo","loadMetaInfo","getMetaInfo","nameList","selected","setItem","catch","err","getItem","storeSelectedNotebook","currentNotebook","getCurrentNotebook","setNotebookInStorage","addNotebook","previousNotebookLabel","notebookNameInput","createItemNameInput","insertAfter","remove","appendChild","focus","e","keyCode","newNotebookName","trim","indexOf","createErrorMessage","length","push","displayNotebookLabel","setSelectedNotebook","notebookName","opts","mergedOpts","storePrevious","storeSelected","oldSelectedNotebook","switchToNewNotebook","add","loadNotebook","addDefaultNotebook","clearSelectedNotebook","getNotebookFromStorage","notebook","Object","keys","forEach","itemName","item","setItemInStorage","updateAtPosition","homePosition","loadNotebookMenu","localStorage","getItemFromStorage","renameNotebook","notebookLabel","oldNotebookName","innerHTML","replaceElementInArray","renameNotebookInStorage","labelPosition","createElement","setAttribute","textContent","removeNotebookFromStorage","removeNotebook","getAttribute","removedNotebookIndex","previousNotebookName","removeElementInArray","clearAllItems","removeItem","clearAllStorage","notebookSize","setTimeout","periodicallyStoreNotebook","target","contains","window"],"mappings":"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","file":"../../TextReader/js/notebookMenu.js","sourcesContent":["// set drivers for localforage, excluding localstorage\r\nlocalforage.setDriver([localforage.WEBSQL, localforage.INDEXEDDB]);\r\n// separate instance for storing meta info\r\nconst metaInfo = localforage.createInstance({\r\n    name: \"metaInfo\"\r\n});\r\nmetaInfo.setDriver([localforage.WEBSQL, localforage.INDEXEDDB]);\r\n\r\nlocalforage.iterate((value, key) => {console.log(key, value)})\r\n\r\nconst toggleBtn = document.querySelector('#hamburger-icon.toggle-btn');\r\nconst sidebar = document.getElementById(\"sidebar\");\r\nconst notebookMenu = sidebar.querySelector(\"ul\");\r\nconst addNotebookBtn = document.getElementById(\"addNotebookBtn\");\r\ntoggleBtn.addEventListener(\"click\", (event) => {\r\n    event.preventDefault(); // prevent scrolling up to top\r\n    sidebar.classList.toggle(\"active\");\r\n    toggleBtn.classList.toggle(\"active\");\r\n});\r\nlet notebookNameList = [];\r\nlet selectedNotebookName; // store the selected notebook name\r\nconst defaultNotebookName = \"notebook1\";\r\n\r\nloadMetaInfo().then(() => {\r\n    const notebookSize = notebookNameList.length;\r\n\tconsole.log('TCL: notebookSize', notebookSize);\r\n    if (notebookSize > 0) {\r\n        // load notebooks in storage\r\n        loadNotebookMenu();\r\n    } else {\r\n        // add default notebook\r\n        addDefaultNotebook();\r\n    }\r\n});\r\n\r\n// periodically store selected notebook\r\nsetTimeout(function periodicallyStoreNotebook() {\r\n    storeSelectedNotebook().then(\r\n        () => {\r\n            console.log(\"storing selected notebook...\");\r\n            setTimeout(periodicallyStoreNotebook, 1000);\r\n        }\r\n    );\r\n}, 1000);\r\n\r\n// select notebook on click\r\nnotebookMenu.addEventListener(\"click\", (e) => {\r\n    const target = e.target;\r\n    if (target.classList.contains(\"notebook\")) {\r\n        target.classList.add(\"selected\");\r\n        const selectedNotebookName = target.getAttribute(\"data-name\");\r\n        setSelectedNotebook(selectedNotebookName);\r\n    }\r\n});\r\n\r\n// add new notebook\r\naddNotebookBtn.addEventListener(\"click\", () => {\r\n    addNotebook();\r\n})\r\n\r\n// store notebook when window is unloaded\r\nwindow.addEventListener(\"beforeunload\", (e) => {\r\n    return \"\";\r\n});\r\n\r\nfunction storeMetaInfo() {\r\n    return metaInfo.clear().then(() => {\r\n        return Promise.all([\r\n            setMetaInfo(\"notebookNameList\", notebookNameList),\r\n            setMetaInfo(\"selectedNotebookName\", selectedNotebookName)\r\n        ]);\r\n    });\r\n}\r\n\r\nfunction loadMetaInfo() {\r\n    return Promise.all([\r\n        getMetaInfo(\"notebookNameList\").then((nameList) => {\r\n            if (nameList) {\r\n                notebookNameList = nameList;\r\n            }\r\n        }),\r\n        getMetaInfo(\"selectedNotebookName\").then((selected) => {\r\n            if (selected) {\r\n                selectedNotebookName = selected;\r\n            }\r\n        })\r\n    ]);\r\n}\r\n\r\nfunction setMetaInfo(key, value) {\r\n    return metaInfo.setItem(key, value).catch(function (err) {\r\n        console.log(err);\r\n    });\r\n}\r\n\r\nfunction getMetaInfo(key) {\r\n    return metaInfo.getItem(key).catch(function (err) {\r\n        console.log(err);\r\n    })\r\n}\r\n\r\nfunction storeSelectedNotebook() {\r\n    const currentNotebook = getCurrentNotebook();\r\n    // console.log('TCL: storeSelectedNotebook -> currentNotebook', selectedNotebookName);\r\n    return setNotebookInStorage(selectedNotebookName, currentNotebook);\r\n}\r\n\r\nfunction addNotebook(previousNotebookLabel) {\r\n    const notebookNameInput = createItemNameInput(\"notebook\");\r\n    if (previousNotebookLabel) {\r\n        insertAfter(previousNotebookLabel, notebookNameInput);\r\n        previousNotebookLabel.remove();\r\n    } else {\r\n        notebookMenu.appendChild(notebookNameInput);\r\n    }\r\n    notebookNameInput.focus();\r\n    notebookNameInput.addEventListener(\"keypress\", (e) => {\r\n        if (e.keyCode == 13) { // ENTER key\r\n            const newNotebookName = notebookNameInput.value.trim();\r\n            if (notebookNameList.indexOf(newNotebookName) >= 0) { // repeated name\r\n                createErrorMessage(notebookNameInput,\r\n                    `Duplicated notebook name`);\r\n            } else if (newNotebookName.length === 0) {\r\n                createErrorMessage(notebookNameInput,\r\n                    `Notebook name cannot be empty`);\r\n            } else {\r\n                // add to notebook name list\r\n                notebookNameList.push(newNotebookName);\r\n                displayNotebookLabel(newNotebookName, notebookNameInput);\r\n                // remove item name input\r\n                notebookNameInput.remove();\r\n                // rename selected notebook\r\n                setSelectedNotebook(newNotebookName);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction setSelectedNotebook(notebookName, opts) {\r\n    const defaultOpts = {\r\n        storePrevious: true,\r\n        storeSelected: true,\r\n    };\r\n    const mergedOpts = {\r\n        ...defaultOpts,\r\n        ...opts\r\n    };\r\n    const storePrevious = mergedOpts.storePrevious;\r\n    const storeSelected = mergedOpts.storeSelected;\r\n\r\n    // delete styling of old selected notebook\r\n    const oldSelectedNotebook = notebookMenu.querySelector(`li[data-name=\"${selectedNotebookName}\"]`);\r\n    if (oldSelectedNotebook) {\r\n        console.log('TCL: setSelectedNotebook -> oldSelectedNotebook', oldSelectedNotebook);\r\n        oldSelectedNotebook.classList.remove(\"selected\");\r\n    }\r\n\r\n    // store previous notebook and switch new newly selected notebook\r\n    if (!storePrevious) {\r\n        selectedNotebookName = notebookName;\r\n    }\r\n    if (storeSelected) {\r\n        storeSelectedNotebook().then(() => {\r\n            switchToNewNotebook();\r\n        });\r\n    } else {\r\n        switchToNewNotebook();\r\n    }\r\n\r\n    function switchToNewNotebook() {\r\n        // switch to newly selected notebook\r\n        selectedNotebookName = notebookName;\r\n        const notebookLabel = notebookMenu.querySelector(`li[data-name=\"${notebookName}\"`);\r\n        notebookLabel.classList.add(\"selected\");\r\n        // load the selected notebook\r\n        loadNotebook(notebookName);\r\n    }\r\n\r\n    storeMetaInfo();\r\n}\r\n\r\n// display and store the default notebook\r\nfunction addDefaultNotebook() {\r\n    console.log('TCL: addDefaultNotebook -> addDefaultNotebook');\r\n    // display the default notebook\r\n    displayNotebookLabel(defaultNotebookName);\r\n    notebookNameList.push(defaultNotebookName);\r\n    // set selected notebook to the default one\r\n    setSelectedNotebook(defaultNotebookName, {\r\n        storePrevious: false\r\n    });\r\n}\r\n\r\nfunction loadNotebook(notebookName) {\r\n    clearSelectedNotebook();\r\n    getNotebookFromStorage(notebookName).then((notebook) => {\r\n        if (notebook instanceof Object) {\r\n            Object.keys(notebook).forEach(itemName => {\r\n                const item = notebook[itemName];\r\n                setItemInStorage(itemName, item);\r\n            });\r\n            updateAtPosition(homePosition);\r\n        }\r\n    });\r\n}\r\n\r\nfunction loadNotebookMenu() {\r\n    console.log('TCL: loadNotebookMenu -> notebookNameList', notebookNameList);\r\n    notebookNameList.forEach(notebookName => {\r\n        console.log('TCL: loadNotebookMenu -> notebookName', notebookName);\r\n        // notebookNameList.push(notebookName);\r\n        displayNotebookLabel(notebookName);\r\n    })\r\n    setSelectedNotebook(selectedNotebookName, {\r\n        storePrevious: false,\r\n        storeSelected: false\r\n    });\r\n}\r\n\r\nfunction getCurrentNotebook() {\r\n    const notebook = {};\r\n    Object.keys(localStorage).forEach(key => {\r\n        // console.log('TCL: key', key);\r\n        notebook[key] = getItemFromStorage(key);\r\n    })\r\n    return notebook;\r\n}\r\n\r\nfunction renameNotebook(notebookLabel) {\r\n    const oldNotebookName = notebookLabel.innerHTML;\r\n    const notebookNameInput = createItemNameInput(\"notebook\");\r\n    insertAfter(notebookLabel, notebookNameInput);\r\n    notebookNameInput.focus();\r\n    notebookLabel.remove();\r\n    notebookNameInput.addEventListener(\"keypress\", (e) => {\r\n        if (e.keyCode == 13) { // ENTER key\r\n            const newNotebookName = notebookNameInput.value;\r\n            if (notebookNameList.indexOf(newNotebookName) >= 0 && newNotebookName !== oldNotebookName) { // repeated name\r\n                createErrorMessage(notebookNameInput,\r\n                    `Duplicated notebook name`);\r\n            } else {\r\n                replaceElementInArray(notebookNameList, oldNotebookName, newNotebookName);\r\n                renameNotebookInStorage(oldNotebookName, newNotebookName);\r\n                displayNotebookLabel(newNotebookName, notebookNameInput);\r\n                // remove item name input\r\n                notebookNameInput.remove();\r\n                // rename selected notebook\r\n                setSelectedNotebook(newNotebookName);\r\n            }\r\n        }\r\n    })\r\n}\r\n\r\nfunction displayNotebookLabel(notebookName, labelPosition) {\r\n    const notebookLabel = document.createElement(\"li\");\r\n    notebookLabel.classList.add(\"item\");\r\n    notebookLabel.classList.add(\"notebook\");\r\n    notebookLabel.setAttribute(\"data-name\", notebookName);\r\n    notebookLabel.textContent = notebookName;\r\n    if (labelPosition) {\r\n        insertAfter(labelPosition, notebookLabel);\r\n    } else {\r\n        notebookMenu.appendChild(notebookLabel);\r\n    }\r\n}\r\n\r\nfunction renameNotebookInStorage(oldNotebookName, newNotebookName) {\r\n    getNotebookFromStorage(oldNotebookName)\r\n        .then((notebook) => setNotebookInStorage(newNotebookName, notebook));\r\n    removeNotebookFromStorage(oldNotebookName);\r\n}\r\n\r\nfunction removeNotebook(notebookLabel) {\r\n    const notebookName = notebookLabel.getAttribute(\"data-name\");\r\n    console.log('TCL: removeNotebook -> notebookName', notebookName);\r\n    removeNotebookFromStorage(notebookName).then(() => {\r\n        console.log(`Doing further operations after removing ${notebookName}...`);\r\n        if (selectedNotebookName === notebookName) {\r\n            clearSelectedNotebook();\r\n            console.log('TCL: removeNotebook -> clearSelectedNotebook');\r\n        }\r\n        const removedNotebookIndex = notebookNameList.indexOf(notebookName);\r\n        let previousNotebookName;\r\n        if (removedNotebookIndex < notebookNameList.length - 1) { // before last\r\n            previousNotebookName = notebookNameList[removedNotebookIndex + 1];\r\n        } else if (removedNotebookIndex > 0) { // last but not the only one\r\n            previousNotebookName = notebookNameList[removedNotebookIndex - 1];\r\n        } else { // last and the only one\r\n            addDefaultNotebook();\r\n        }\r\n        if (previousNotebookName) {\r\n            console.log('TCL: removeNotebook -> previousNotebookName', previousNotebookName);\r\n            setSelectedNotebook(previousNotebookName, {\r\n                storePrevious: false\r\n            });\r\n        }\r\n        removeElementInArray(notebookNameList, notebookName);\r\n        notebookLabel.remove();\r\n    });\r\n}\r\n\r\n// Remove all items from storage and delete all labels!!!\r\nfunction clearSelectedNotebook() {\r\n    clearAllItems();\r\n    localStorage.clear();\r\n}\r\n\r\nfunction removeNotebookFromStorage(notebookName) {\r\n    console.log('TCL: removeNotebookFromStorage -> removeNotebookFromStorage', notebookName);\r\n    return localforage.removeItem(notebookName).catch(function (err) {\r\n        console.log(err);\r\n    });\r\n}\r\n\r\nfunction getNotebookFromStorage(notebookName) {\r\n    return localforage.getItem(notebookName);\r\n}\r\n\r\nfunction setNotebookInStorage(notebookName, notebook) {\r\n    return localforage.setItem(notebookName, notebook).catch(err => {\r\n        console.log(err);\r\n    });\r\n}\r\n\r\nfunction clearAllStorage(){\r\n    notebookNameList = [];\r\n    localStorage.clear();\r\n    localforage.clear();\r\n    metaInfo.clear();\r\n}"]}